services:
  devbox:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ${IMAGE_NAME:-ghcr.io/jclement/devbox:latest}
    hostname: ${CONTAINER_NAME:-${COMPOSE_PROJECT_NAME}}

    # Capabilities for Tailscale (only needed if using TS_AUTHKEY)
    # For local mode only, you can comment these out
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun

    environment:
      # System Configuration
      TZ: ${TZ:-UTC}

      # User Configuration (matches host user)
      USER_UID: ${USER_UID:-1000}
      USER_GID: ${USER_GID:-1000}
      USERNAME: ${USERNAME:-devbox}
      PASSWORD: ${PASSWORD:-}  # Optional: SSH/code-server password

      # Database Configuration
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-devdb}

      # Tailscale Configuration (leave empty for local mode)
      TS_AUTHKEY: ${TS_AUTHKEY:-}
      TS_HOSTNAME: ${TS_HOSTNAME:-${COMPOSE_PROJECT_NAME}}
      TS_SUFFIX: ${TS_SUFFIX:-}

      # Cloudflare Tunnel Configuration (optional)
      CF_TUNNEL_TOKEN: ${CF_TUNNEL_TOKEN:-}

      # Webroot URL override (optional - auto-computed if not set)
      WEBROOT: ${WEBROOT:-}

      # Service Configuration
      DEV_SERVICE_PORT: ${DEV_SERVICE_PORT:-3000}
      MISE_GLOBAL_TOOLS: ${MISE_GLOBAL_TOOLS:-}

      # Code-Server Configuration
      VSCODE_DEFAULT_EXTENSIONS: ${VSCODE_DEFAULT_EXTENSIONS:-}
      VSCODE_DEFAULT_THEME: ${VSCODE_DEFAULT_THEME:-}

      # Port Configuration (for display in entrypoint messages)
      SSH_PORT: ${SSH_PORT:-2200}
      CADDY_PORT: ${CADDY_PORT:-8400}
      POSTGRES_PORT: ${POSTGRES_PORT:-5400}

      # Container Metadata
      CONTAINER_NAME: ${CONTAINER_NAME:-${COMPOSE_PROJECT_NAME}}

      # Terminal Configuration
      TERM: ${TERM:-xterm-256color}
      COLORTERM: truecolor

      # Optional Lifecycle Hooks (can point to custom scripts or be overridden with volumes)
      PRE_START_HOOK: ${PRE_START_HOOK:-/opt/hooks/pre_start.sh}
      POST_START_HOOK: ${POST_START_HOOK:-/opt/hooks/post_start.sh}
      PRE_RESTORE_HOOK: ${PRE_RESTORE_HOOK:-/opt/hooks/pre_restore.sh}
      POST_RESTORE_HOOK: ${POST_RESTORE_HOOK:-/opt/hooks/post_restore.sh}
      INITIAL_SCHEMA: ${INITIAL_SCHEMA:-/opt/hooks/initial_schema.sql}

    volumes:
      # Workspace - bind mount for persistence
      - ./data/workspace:/workspace

      # Optional: Override hook scripts by bind mounting custom scripts
      # Example: - ./my-hooks/pre_start.sh:/opt/hooks/pre_start.sh
      # Example: - ./my-schema.sql:/opt/hooks/initial_schema.sql

      # SSH directory - contains authorized_keys and any keypairs
      - ${SSH_DIR:-${HOME}/.ssh}:/home/${USERNAME:-devbox}/.ssh

      # Git config (read-only from host)
      - ${HOME}/.gitconfig:/home/${USERNAME:-devbox}/.gitconfig-host:ro

      # Vim configuration (optional)
      - ${HOME}/.vimrc:/home/${USERNAME:-devbox}/.vimrc
      - ${HOME}/.vim:/home/${USERNAME:-devbox}/.vim
      - ${HOME}/.vim_runtime:/home/${USERNAME:-devbox}/.vim_runtime

      # Database snapshots (persist on host)
      - ${SNAPSHOTS_DIR:-./data/snapshots}:/snapshots

      # System state (PostgreSQL, Tailscale, SSH host keys)
      - ./data/state:/state

      # Mount Home Directory
      #- ./data/home:/home/${USERNAME:-devbox}

    # Ports only used in local mode (Tailscale mode doesn't need port mappings)
    # Uncomment these in .env to run multiple instances on same host
    #ports:
    #  - "${SSH_PORT:-2200}:22"           # SSH
    #  - "${CADDY_PORT:-8400}:8443"       # Caddy (web services)
    #  - "${POSTGRES_PORT:-5400}:5432"    # PostgreSQL

    # Restart policy
    restart: ${RESTART_POLICY:-unless-stopped}

    # Health check
    healthcheck:
      test: ["CMD", "/command/s6-rc", "-a", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

