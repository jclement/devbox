services:
  devbox:
    build:
      context: .
      dockerfile: docker/Dockerfile
    image: ${IMAGE_NAME:-ghcr.io/jclement/devbox:latest}
    hostname: ${CONTAINER_NAME:-${COMPOSE_PROJECT_NAME}}

    # Capabilities for Tailscale (only needed if using TS_AUTHKEY)
    # For local mode only, you can comment these out
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun

    environment:
      # User Configuration (matches host user)
      USER_UID: ${USER_UID:-1000}
      USER_GID: ${USER_GID:-1000}
      USERNAME: ${USERNAME:-devbox}
      PASSWORD: ${PASSWORD:-}  # Optional: SSH/code-server password

      # Database Configuration
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-devdb}

      # Tailscale Configuration (leave empty for local mode)
      TS_AUTHKEY: ${TS_AUTHKEY:-}
      TS_HOSTNAME: ${TS_HOSTNAME:-${COMPOSE_PROJECT_NAME}}
      TS_SUFFIX: ${TS_SUFFIX:-}

      # Cloudflare Tunnel Configuration (optional)
      CF_TUNNEL_TOKEN: ${CF_TUNNEL_TOKEN:-}

      # Service Configuration
      DEV_SERVICE_PORT: ${DEV_SERVICE_PORT:-3000}

      # Port Configuration (for display in entrypoint messages)
      SSH_PORT: ${SSH_PORT:-2200}
      CADDY_PORT: ${CADDY_PORT:-8400}
      POSTGRES_PORT: ${POSTGRES_PORT:-5400}

      # Container Metadata
      CONTAINER_NAME: ${CONTAINER_NAME:-${COMPOSE_PROJECT_NAME}}

      # Terminal Configuration
      TERM: ${TERM:-xterm-256color}
      COLORTERM: truecolor

      # Optional Lifecycle Hooks
      PRE_STARTUP_CMD: ${PRE_STARTUP_CMD:-}
      DB_SEED_FILE: ${DB_SEED_FILE:-}
      POST_STARTUP_CMD: ${POST_STARTUP_CMD:-}

    volumes:
      # Workspace - bind mount for persistence
      - ./data/workspace:/workspace

      # SSH directory - contains authorized_keys and any keypairs
      - ./ssh:/home/${USERNAME:-devbox}/.ssh

      # Git config (read-only from host)
      - ${HOME}/.gitconfig:/home/${USERNAME:-devbox}/.gitconfig-host:ro

      # Vim configuration (optional)
      - ${HOME}/.vimrc:/home/${USERNAME:-devbox}/.vimrc
      - ${HOME}/.vim:/home/${USERNAME:-devbox}/.vim
      - ${HOME}/.vim_runtime:/home/${USERNAME:-devbox}/.vim_runtime

      # Database snapshots (persist on host)
      - ./data/snapshots:/snapshots

      # System state (PostgreSQL, Tailscale, SSH host keys)
      - ./data/state:/state

    # Ports only used in local mode (Tailscale mode doesn't need port mappings)
    # Uncomment these in .env to run multiple instances on same host
    #ports:
    #  - "${SSH_PORT:-2200}:22"           # SSH
    #  - "${CADDY_PORT:-8400}:8443"       # Caddy (web services)
    #  - "${POSTGRES_PORT:-5400}:5432"    # PostgreSQL

    # Restart policy
    restart: ${RESTART_POLICY:-unless-stopped}

    # Health check
    healthcheck:
      test: ["CMD", "/command/s6-rc", "-a", "list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

